async function downloadPDF() {
  if (!window.jspdf) {
    alert('PDF-Bibliothek lädt noch. Bitte einen Moment warten und erneut versuchen.');
    return;
  }

  if (!pdfTemplate) {
    alert('Bitte lade zuerst eine PDF-Vorlage hoch!');
    document.getElementById('pdfWarning').style.display = 'block';
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  for (let cardIndex = 0; cardIndex < cards.length; cardIndex++) {
    if (cardIndex > 0) {
      pdf.addPage();
    }

    const card = cards[cardIndex];
    
    // Füge PDF-Hintergrund als Bild hinzu
    pdf.addImage(pdfTemplate, 'PNG', 0, 0, 210, 297);

    // Position und Größe des Bingo-Felds
    const startX = 25;  // 25mm von links
    const startY = 90;  // 90mm von oben
    const gridWidth = 160;  // 160mm breit
    const gridHeight = 160; // 160mm hoch
    const cellSize = gridWidth / gridSize;

    // Zeichne nur die inneren Linien (hellgrau)
    pdf.setDrawColor(200, 200, 200);  // Hellgrau
    pdf.setLineWidth(0.3);

    // Vertikale Linien
    for (let i = 1; i < gridSize; i++) {
      const x = startX + i * cellSize;
      pdf.line(x, startY, x, startY + gridHeight);
    }

    // Horizontale Linien
    for (let i = 1; i < gridSize; i++) {
      const y = startY + i * cellSize;
      pdf.line(startX, y, startX + gridWidth, y);
    }

    // Füge Text in Zellen ein
    for (let row = 0; row < gridSize; row++) {
      for (let col = 0; col < gridSize; col++) {
        const x = startX + col * cellSize;
        const y = startY + row * cellSize;
        const index = row * gridSize + col;
        const text = card[index] || '';

        // Hintergrund für FREI (mit abgerundeten Ecken)
        if (text === 'FREI') {
          pdf.setFillColor(220, 240, 220);
          pdf.roundedRect(x + 1, y + 1, cellSize - 2, cellSize - 2, 3, 3, 'F');
        }

        // Text
        pdf.setTextColor(text === 'FREI' ? 34 : 0, text === 'FREI' ? 139 : 0, text === 'FREI' ? 34 : 0);
        const fontSize = Math.max(9, 16 - gridSize * 1.5);
        pdf.setFontSize(fontSize);

        const maxWidth = cellSize - 6;
        const lines = pdf.splitTextToSize(text, maxWidth);
        const lineHeight = fontSize * 0.4;
        const totalHeight = lines.length * lineHeight;
        const textStartY = y + (cellSize - totalHeight) / 2 + lineHeight;

        lines.forEach((line, i) => {
          pdf.text(line, x + cellSize / 2, textStartY + i * lineHeight, {
            align: 'center',
            maxWidth: maxWidth
          });
        });
      }
    }

    // Fußzeile: X/XX
    pdf.setFontSize(10);
    pdf.setTextColor(100, 100, 100);
    pdf.text(`${cardIndex + 1}/${cards.length}`, 105, 287, { align: 'center' });
  }

  pdf.save('weihnachts-bingo-karten.pdf');
}
